#!/usr/bin/env sh
set -eu

repo_dir="${SNAP_COMMON}/etc-dot-pihole"
config_dir="${SNAP_COMMON}/etc-pihole"
logs_dir="${SNAP_COMMON}/var-log-pihole"
tmp_dir="${SNAP_COMMON}/tmp"
run_dir="${SNAP_COMMON}/run"
seed_marker="${repo_dir}/.snap-seeded"
defaults_marker="${config_dir}/.snap-defaults-applied"

mkdir -p "${repo_dir}" "${config_dir}" "${logs_dir}" "${tmp_dir}" "${run_dir}"

# Keep a writable repository mirror for scripts that read/write /etc/.pihole.
# Seed once; later hook runs must not rewrite this tree.
if [ ! -e "${seed_marker}" ]; then
  (
    cd "${SNAP}/etc/.pihole"
    tar -cpf - .
  ) | (
    cd "${repo_dir}"
    tar -xpf -
  )
  touch "${seed_marker}"
fi

# Seed branch pin used by updater scripts when absent.
if [ ! -f "${config_dir}/ftlbranch" ]; then
  printf "master\n" > "${config_dir}/ftlbranch"
fi

# Apply first-run defaults that make remote bring-up predictable.
if [ ! -e "${defaults_marker}" ]; then
  "${SNAP}/usr/bin/pihole-FTL" --config webserver.port "8080o,8443os" >/dev/null 2>&1 || true
  touch "${defaults_marker}"
fi

# Force Snap-safe locations and known web paths.
"${SNAP}/usr/bin/pihole-FTL" --config files.pid "${run_dir}/pihole-FTL.pid" >/dev/null 2>&1 || true
"${SNAP}/usr/bin/pihole-FTL" --config files.gravity_tmp "${tmp_dir}" >/dev/null 2>&1 || true
"${SNAP}/usr/bin/pihole-FTL" --config files.log.ftl "${logs_dir}/FTL.log" >/dev/null 2>&1 || true
"${SNAP}/usr/bin/pihole-FTL" --config files.log.dnsmasq "${logs_dir}/pihole.log" >/dev/null 2>&1 || true
"${SNAP}/usr/bin/pihole-FTL" --config files.log.webserver "${logs_dir}/webserver.log" >/dev/null 2>&1 || true
"${SNAP}/usr/bin/pihole-FTL" --config webserver.paths.webroot "/var/www/html" >/dev/null 2>&1 || true
"${SNAP}/usr/bin/pihole-FTL" --config webserver.paths.webhome "/admin" >/dev/null 2>&1 || true
